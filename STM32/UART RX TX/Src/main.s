    .syntax unified
    .cpu cortex-m3
    .thumb
    .global main

main:
    @----------------------------------------------------------
    @ RCC Clock enable: GPIOA + USART1
    @----------------------------------------------------------
    LDR     R0, =0x40021018      @ RCC_APB2ENR
    LDR     R1, [R0]
    ORR     R1, R1, #(1 << 2)    @ IOPAEN
    ORR     R1, R1, #(1 << 14)   @ USART1EN
    STR     R1, [R0]

    @----------------------------------------------------------
    @ GPIOA: PA9=TX(AF PP), PA10=RX(Floating)
    @----------------------------------------------------------
    LDR     R0, =0x40010804      @ GPIOA_CRH
    LDR     R1, [R0]
    BIC     R1, R1, #(0xF << 4)  @ clear MODE9/CNF9
    BIC     R1, R1, #(0xF << 8)  @ clear MODE10/CNF10
    ORR     R1, R1, #(0xB << 4)  @ PA9 = AF PP 50MHz
    ORR     R1, R1, #(0x4 << 8)  @ PA10 = Floating input
    STR     R1, [R0]

    @----------------------------------------------------------
    @ USART1 BRR: 9600 baud, 8MHz clock
    @----------------------------------------------------------
    LDR     R0, =0x40013808      @ USART1_BRR
    LDR     R1, =0x341
    STR     R1, [R0]

    @----------------------------------------------------------
    @ USART1 enable: UE + TE + RE
    @----------------------------------------------------------
    LDR     R0, =0x4001380C
    LDR     R1, =0x200C
    STR     R1, [R0]

loop:
    @----------------------------------------------------------
    @ Wait for RXNE
    @----------------------------------------------------------
wait_rx:
    LDR     R0, =0x40013800      @ USART1_SR
    LDR     R1, [R0]
    TST     R1, #0x20             @ RXNE bit
    BEQ     wait_rx

    @----------------------------------------------------------
    @ Read received character
    @----------------------------------------------------------
    LDR     R0, =0x40013804      @ USART1_DR
    LDRB    R2, [R0]             @ received char in R2

    @----------------------------------------------------------
    @ Wait for TXE
    @----------------------------------------------------------
wait_tx:
    LDR     R0, =0x40013800      @ USART1_SR
    LDR     R1, [R0]
    TST     R1, #0x80             @ TXE bit
    BEQ     wait_tx

    @----------------------------------------------------------
    @ Echo character
    @----------------------------------------------------------
    LDR     R0, =0x40013804
    STRB    R2, [R0]

    B       loop
